<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة العامل - Wassal Khedma</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f7f9;
    }

    nav {
      background-color: #2c3e50;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    nav img {
      height: 45px;
    }

    nav .links a {
      color: white;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
    }

    nav .links a:hover {
      color: #1abc9c;
    }

    nav .notifications {
      position: relative;
      cursor: pointer;
      font-size: 20px;
    }

    nav .notifications span {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 50%;
    }

    .dashboard {
      padding: 40px 20px;
      max-width: 1200px;
      margin: auto;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .card {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    .card h2 {
      margin: 0;
      color: #3498db;
      font-size: 36px;
    }

    .card p {
      margin-top: 10px;
      font-size: 18px;
      color: #555;
    }

    .profile {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 40px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    #map {
      height: 400px;
      width: 100%;
      margin-top: 40px;
      border-radius: 10px;
    }

    /* زر فتح لوحة تحكم الأدمن */
    .admin-dashboard-link {
      display: none; /* تظهر فقط للأدمن */
      width: max-content;
      margin: 30px auto 0;
      background-color: #2980b9;
      color: white;
      font-weight: bold;
      padding: 10px 15px;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s ease;
      text-align: center;
      cursor: pointer;
    }

    .admin-dashboard-link:hover {
      background-color: #1abc9c;
    }

    .footer {
      background-color: #2c3e50;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 50px;
      user-select: none;
    }
  </style>
</head>
<body>

  <!-- حماية الصفحة -->
  <script>
    // قراءة الدور من localStorage مع تنظيف المسافات وتحويل للحروف الصغيرة
    let roleRaw = localStorage.getItem("role") || "";
    const role = roleRaw.trim().toLowerCase();

    // السماح فقط للعمال أو الأدمن بالدخول
    if (role !== "worker" && role !== "admin") {
      alert("❌ ليس لديك صلاحية الوصول لهذه الصفحة.");
      window.location.href = "login.html";
    }
  </script>

  <!-- شريط التنقل -->
  <nav>
    <div class="logo">
      <img src="images/wassal.jfif" alt="Wassal Khedma" />
    </div>
    <div class="links" id="navLinks">
      <!-- سيتم بناء الروابط ديناميكياً -->
    </div>
    <div class="notifications" onclick="showNotifications()" aria-label="الإشعارات">
      🔔 <span id="notifCount" aria-live="polite" aria-atomic="true">0</span>
    </div>
  </nav>

  <div class="dashboard">
    <h1>مرحبًا بك في لوحة العامل - Wassal Khedma</h1>

    <div class="cards" id="cardsContainer">
      <div class="card">
        <h2 id="requestCount">0</h2>
        <p>عدد الطلبات الجديدة</p>
      </div>
      <div class="card">
        <h2 id="completedCount">0</h2>
        <p>الطلبات المكتملة</p>
      </div>
    </div>

    <!-- بيانات العامل -->
    <div class="profile" id="workerProfile">
      <h3>بياناتك الشخصية</h3>
      <p><strong>الاسم:</strong> <span id="workerName">غير محدد</span></p>
      <p><strong>البريد الإلكتروني:</strong> <span id="workerEmail">غير محدد</span></p>
      <p><strong>الخدمة:</strong> <span id="workerService">غير محدد</span></p>
      <p><strong>المدينة:</strong> <span id="workerLocation">غير محدد</span></p>
    </div>

    <!-- زر لوحة تحكم الأدمن يظهر فقط للأدمن -->
    <a href="dashboard.html" id="adminDashboardBtn" class="admin-dashboard-link">
      فتح لوحة تحكم الأدمن
    </a>

    <h2 style="margin-top: 50px; color: #2c3e50;">مواقع العملاء</h2>
    <div id="map"></div>
  </div>

  <div class="footer">
    &copy; 2025 Wassal Khedma - جميع الحقوق محفوظة
  </div>

  <script>
    // بناء روابط النافبار حسب الدور (عامل أو أدمن)
    const navLinks = document.getElementById("navLinks");

    function buildNavLinks() {
      let linksHTML = '';

      if (role === "admin") {
        // روابط الأدمن كاملة
        linksHTML = `
          <a href="dashboard.html">لوحة التحكم</a>
          <a href="workers.html">إدارة العمال</a>
          <a href="clients.html">إدارة العملاء</a>
          <a href="requests.html">الطلبات</a>
          <a href="payments.html">المدفوعات</a>
          <a href="#" id="logoutLink">تسجيل الخروج</a>
        `;

        // نظهر زر دخول لوحة تحكم الأدمن
        document.getElementById("adminDashboardBtn").style.display = "block";

        // نظهر بطاقات إضافية للأدمن (مثال)
        document.getElementById("cardsContainer").innerHTML = `
          <div class="card">
            <h2 id="workerCount">0</h2>
            <p>عدد العمال</p>
          </div>
          <div class="card">
            <h2 id="clientCount">0</h2>
            <p>عدد العملاء</p>
          </div>
          <div class="card">
            <h2 id="requestCount">0</h2>
            <p>عدد الطلبات</p>
          </div>
          <div class="card">
            <h2 id="paymentCount">0</h2>
            <p>عدد المدفوعات</p>
          </div>
        `;
      } else if (role === "worker") {
        // روابط العامل فقط
        linksHTML = `
          <a href="worker_dashboard.html">لوحة العامل</a>
          <a href="my_requests.html">طلباتي</a>
          <a href="workers.html">كل العمال</a>
          <a href="#" id="logoutLink">تسجيل الخروج</a>
        `;
      }

      navLinks.innerHTML = linksHTML;
    }

    buildNavLinks();

    // تسجيل الخروج بمسح localStorage وتحويل لصفحة تسجيل الدخول
    document.addEventListener("click", e => {
      if (e.target.id === "logoutLink") {
        e.preventDefault();
        localStorage.clear();  // هنا تمسح كل البيانات، لو تفضل فقط مسح بعض القيم عدل هنا
        alert("✅ تم تسجيل الخروج بنجاح");
        window.location.href = "login.html";
      }
    });

    // تحميل بيانات العامل من LocalStorage (أو بيانات الأدمن لو تحب)
    const currentWorkerId = localStorage.getItem("current_worker_id");
    const workersList = JSON.parse(localStorage.getItem("workers")) || [];
    const workerData = workersList.find(w => w.id == currentWorkerId) || {};

    document.getElementById("workerName").innerText = workerData.name || "غير محدد";
    document.getElementById("workerEmail").innerText = workerData.email || "غير محدد";
    document.getElementById("workerService").innerText = workerData.service || "غير محدد";
    document.getElementById("workerLocation").innerText = workerData.location || "غير محدد";

    // بيانات الطلبات
    let newRequests = JSON.parse(localStorage.getItem("new_requests")) || [];
    let completedRequests = JSON.parse(localStorage.getItem("completed_requests")) || [];

    if (role === "worker") {
      // تصفية الطلبات الخاصة بهذا العامل فقط
      newRequests = newRequests.filter(r => r.workerId == currentWorkerId);
      completedRequests = completedRequests.filter(r => r.workerId == currentWorkerId);
    }

    document.getElementById("requestCount").innerText = newRequests.length;
    document.getElementById("completedCount").innerText = completedRequests.length;
    document.getElementById("notifCount").innerText = newRequests.length;

    // بيانات إضافية للأدمن (عدد العمال، العملاء، الطلبات، المدفوعات)
    if (role === "admin") {
      const users = JSON.parse(localStorage.getItem("wassal_users")) || [];
      const payments = JSON.parse(localStorage.getItem("wassal_payments")) || [];

      document.getElementById("workerCount").innerText = users.filter(u => u.role === "worker").length;
      document.getElementById("clientCount").innerText = users.filter(u => u.role === "client").length;
      document.getElementById("requestCount").innerText = newRequests.length + completedRequests.length;
      document.getElementById("paymentCount").innerText = payments.length;
    }

    // عرض الإشعارات
    function showNotifications() {
      if (newRequests.length > 0) {
        alert("📢 لديك " + newRequests.length + " طلبات جديدة.");
      } else {
        alert("✅ لا توجد طلبات جديدة.");
      }
    }

    // Google Map - عرض مواقع العملاء بناء على الطلبات الجديدة
    function initMap() {
      const egyptCenter = { lat: 30.0444, lng: 31.2357 };
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: egyptCenter,
      });

      newRequests.forEach(req => {
        if (req.lat && req.lng) {
          new google.maps.Marker({
            position: { lat: req.lat, lng: req.lng },
            map,
            title: `طلب من ${req.clientName || 'عميل'}`,
          });
        }
      });
    }
  </script>

  <!-- استبدل YOUR_API_KEY بمفتاحك الخاص -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
  </script>

</body>
</html>
